name: Daily Java Coding Challenges

on:
  workflow_dispatch:
  schedule:
    - cron: '5 15 * * *'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.AUTOBOT_TOKEN != '' && secrets.AUTOBOT_TOKEN || github.token }}
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "Redeem Grimm Bot"
          git config user.email "actions@users.noreply.github.com"

      - name: Generate, PR, and merge 10 daily challenges (mixed topics)
        env:
          GH_TOKEN: ${{ secrets.AUTOBOT_TOKEN != '' && secrets.AUTOBOT_TOKEN || github.token }}
        run: |
          set -euo pipefail
          DATE=$(TZ=America/New_York date +%F)
          BASE=main

          for i in $(seq 1 10); do
            git fetch origin "$BASE"
            git checkout -B "$BASE" "origin/$BASE"

            BRANCH="daily/${DATE}-q${i}"
            git checkout -B "$BRANCH"

            export DATE I="$i"
            TOPIC=$(python3 .github/scripts/generate_daily_challenge.py | head -n 1)

            git add .
            if git diff --cached --quiet; then
              echo "No changes for challenge ${i}; skipping commit."
              continue
            fi

            git commit -m "feat(java-challenge): add ${TOPIC} challenge ${i} for ${DATE}"
            git push -u origin "$BRANCH"

            PR_NUMBER=$(gh pr list --head "$BRANCH" --base "$BASE" --json number --jq '.[0].number // empty')
            if [[ -z "$PR_NUMBER" ]]; then
              gh pr create \
                --base "$BASE" \
                --head "$BRANCH" \
                --title "feat: add ${TOPIC} Java challenge ${i} (${DATE})" \
                --body "Automated daily Java coding challenge with mixed topics and professional solution structure." || true
              PR_NUMBER=$(gh pr list --head "$BRANCH" --base "$BASE" --json number --jq '.[0].number // empty')
            fi

            if [[ -n "$PR_NUMBER" ]]; then
              gh pr merge "$PR_NUMBER" --squash --delete-branch || gh pr merge "$PR_NUMBER" --squash --delete-branch --admin
            fi
          done
